---
title: "onset-search"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{onset-search}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = F,
  message = F,
  out.width = '60%'
)
```

```{r setup}
library(navr)
library(ggplot2)
obj <- navr_object_preprocessed
```

## Speed clearning
Firstly we clear the speeds of any unreal ones
```{r}
obj <- remove_unreal_speeds(obj, type = "std", cutoff = 3, total_recalculate = T)
plot_speed(obj) + xlim(100,150)
```
And then we smooth it
```{r}
obj <- smooth_speed(obj, type = "median", points = 11)
plot_speed(obj) + xlim(100, 150) 
```

## Onset search
There are several options to onset searching. Let's start with the simple every time it is above certain threshold and for at least 1 s

```{r}
ls <- search_onsets(obj, speed_threshold = 5, min_duration = 2)
plot_speed(obj) + geom_navr_timeseries_events(ls$time_since_start, color="green", size=1.5)  + xlim(100,300)
```
 
Seems to be working well. Now we can modify the onset search to only capture onsets which are preceded by stillness

```{r}
ls <- search_onsets(obj, speed_threshold = 5, min_duration = 2, still_duration = 2)
plot_speed(obj) + geom_navr_timeseries_events(ls$time_since_start, color="green", size=1.5)  + xlim(100,300)
```

And we can also plot the stops with the durations value
```{r}
plot_speed(obj) + geom_navr_timeseries_events(ls$time_since_start, color="green", size=1.5) + 
   geom_navr_timeseries_events(ls$time_since_start+ls$duration, color="red", size=1.5) + xlim(100,300)
```

And next we can also designate slightly different speeds for still and moving speeds

```{r}
times <- search_onsets(obj, speed_threshold = 5, min_duration = 1, still_duration = 2, still_speed_threshold = 2)
plot_speed(obj) + geom_navr_timeseries_events(ls$time_since_start, color="green", size=1.5)  + xlim(100,300)
```
